<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Maouku - Koleksi Jersey</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins :wght@700&family=Open+Sans&family=Montserrat:wght@500&display=swap" rel="stylesheet">

  <style>
    /* Sama seperti sebelumnya — bisa disalin dari HTML final */
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0b0c2a, #121933);
      color: #00c3ff;
      text-align: center;
      padding: 20px 10px;
      margin: 0;
    }

    .mobile-wrapper {
      max-width: 420px;
      margin: auto;
      width: 100%;
    }

    h1 {
      font-weight: 700;
      color: #00c3ff;
      text-shadow: 0 0 5px #00c3ff;
      margin-bottom: 15px;
    }

    .divider {
      width: 100%;
      height: 1px;
      background: linear-gradient(to right, transparent, #00c3ff55, transparent);
      margin: 15px 0;
    }

    .post {
      margin-bottom: 25px;
      border-radius: 12px;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 20px rgba(0, 195, 255, 0.1);
    }

    .slider img {
      width: 100%;
      display: block;
    }

    .nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background-color: rgba(0,0,0,0.5);
      color: white;
      border: none;
      padding: 10px;
      cursor: pointer;
    }

    .prev { left: 10px; }
    .next { right: 10px; }

    .post-content {
      padding: 15px;
      font-size: 14px;
      color: #00f0ff;
    }

    .btn-wa {
      display: inline-block;
      margin-top: 10px;
      padding: 10px 20px;
      background-color: #25D366;
      color: white;
      text-decoration: none;
      border-radius: 25px;
      font-size: 14px;
      font-weight: bold;
      transition: background 0.3s ease;
      font-family: 'Montserrat', sans-serif;
      cursor: pointer;
    }

    .btn-wa:hover {
      background-color: #1ebd58;
    }

    /* MODAL CHECKOUT */
    #checkoutModal {
      display:none;
      position:fixed;
      top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.95); z-index:9999; padding:20px; overflow:auto;
    }

    #invoicePreview strong {
      color: #00c3ff;
    }

    #sizeOptions button {
      padding:8px 16px;
      border-radius:20px;
      background:#0c1a30;
      color:#00c3ff;
      border:1px solid #00c3ff;
      cursor:pointer;
      margin:5px;
    }

    #sizeOptions button[active] {
      background:#00c3ff;
      color:#000;
    }

    #sendWaBtn {
      background-color: #25D366;
      color: white;
      border: none;
      padding:12px 20px;
      border-radius:25px;
      font-weight:bold;
      font-family:'Montserrat', sans-serif;
      cursor:not-allowed;
      opacity:0.6;
      width:100%;
      max-width:300px;
      margin:0 auto;
      display:block;
    }

    #sendWaBtn:enabled {
      cursor:pointer;
      opacity:1;
    }
  </style>
</head>
<body>

<div class="mobile-wrapper">
  <h1>Maouku - Koleksi Jersey</h1>
  <div class="divider"></div>
  <div id="posts"></div>
</div>

<!-- MODAL CHECKOUT -->
<div id="checkoutModal">
  <h2 style="color:#00c3ff;">📦 Invoice Pesanan</h2>
  <p style="color:#99dfff;">Harap pilih ukuran sebelum mengirim</p>
  <hr style="border:1px solid #00c3ff33; margin:15px 0;">
  
  <div id="invoicePreview">
    <strong>Nama:</strong> <span id="invName">-</span><br/>
    <strong>Harga:</strong> <span id="invPrice">-</span><br/>
    <strong>Ukuran:</strong> <span id="invSize">-</span><br/>
    <strong>Gambar:</strong><br/>
    <img id="invImage" src="" alt="Preview Gambar"><br/>
    <strong>Tanggal:</strong> <span id="invDate">-</span><br/>
  </div>

  <hr style="border:1px solid #00c3ff33; margin:15px 0;">

  <div style="margin-bottom:20px;">
    <p style="color:#fff;">Pilih Ukuran:</p>
    <div id="sizeOptions"></div>
  </div>

  <button id="sendWaBtn" onclick="sendToWhatsApp()" disabled>💬 Kirim ke WhatsApp</button>
</div>

<script>
  let selectedSize = null;
  let currentProduct = null;

  // Ambil semua produk saat halaman dimuat
  window.addEventListener('load', () => {
    google.script.run
      .withSuccessHandler(posts => {
        window.products = posts;
        renderPosts(posts);
      })
      .getProducts();
  });

  function renderPosts(products) {
    const container = document.getElementById('posts');
    container.innerHTML = '';

    products.forEach((product, index) => {
      const postDiv = document.createElement('div');
      postDiv.className = 'post';

      const slidesHTML = product.images.map(img => `
        <div class="slide"><img src="${img}" alt="Gambar"></div>
      `).join('');

      const sliderHTML = `
        <div class="slider" style="position:relative;overflow:hidden;width:100%;">
          <div class="slides" id="slider${index}">
            ${slidesHTML}
          </div>
        </div>
      `;

      postDiv.innerHTML = sliderHTML + `
        <div class="post-content">
          <h3>${product.title}</h3>
          <p>${product.description}</p>
          <div class="price">${product.price}</div>
          <div class="varian">Ukuran: ${product.varian}</div>
          <button onclick="openCheckout(${index})" class="btn-wa">💬 Pesan via WhatsApp</button>
        </div>
      `;

      container.appendChild(postDiv);
    });
  }

  function openCheckout(index) {
    currentProduct = window.products[index];
    if (!currentProduct) {
      alert("Produk tidak ditemukan");
      return;
    }

    document.getElementById('invName').innerText = currentProduct.title;
    document.getElementById('invPrice').innerText = currentProduct.price;
    document.getElementById('invImage').src = currentProduct.images[0] || '';
    document.getElementById('invDate').innerText = new Date().toLocaleDateString('id-ID');

    const sizeContainer = document.getElementById('sizeOptions');
    sizeContainer.innerHTML = '';
    selectedSize = null;

    const sizes = (currentProduct.varian || 'S,M,L,XL').split(',').map(s => s.trim());

    const varianHarga = parseVarianHarga(currentProduct.harga_ukuran);

    sizes.forEach(size => {
      const btn = document.createElement('button');
      btn.innerText = size;
      btn.onclick = () => {
        selectedSize = size;
        document.querySelectorAll('#sizeOptions button').forEach(b => b.removeAttribute('active'));
        btn.setAttribute('active', 'true');
        document.getElementById('invSize').innerText = size;

        const basePrice = parseInt(currentProduct.price.replace(/[^\d]/g, ""));
        const addPrice = varianHarga[size.toUpperCase()] || 0;
        const totalPrice = basePrice + addPrice;
        document.getElementById('invPrice').innerText = formatCurrency(totalPrice);

        document.getElementById('sendWaBtn').disabled = false;
        document.getElementById('sendWaBtn').style.opacity = '1';
      };
      sizeContainer.appendChild(btn);
    });

    document.getElementById('checkoutModal').style.display = 'block';
  }

  function sendToWhatsApp() {
    if (!selectedSize) {
      alert("Silakan pilih ukuran dulu");
      return;
    }

    const invName = document.getElementById('invName').innerText;
    const invPrice = document.getElementById('invPrice').innerText;
    const invSize = document.getElementById('invSize').innerText;
    const invImage = document.getElementById('invImage').src;

    const messageWA = `
📦 MAOUKU STORE
   INVOICE PEMESANAN

📌 Nama: ${invName}
💰 Harga: ${invPrice}
📏 Ukuran: ${invSize}
🖼️ Gambar: ${invImage}
📅 Tanggal: ${new Date().toLocaleDateString('id-ID')}

Terima kasih telah memesan!
`;

    const waLink = `https://wa.me/6285162701802?text= ${encodeURIComponent(messageWA)}`;
    window.open(waLink, '_blank');

    // Simpan ke sheet
    google.script.run.saveOrder(invName, "User", invSize, invPrice, invImage);
  }

  function parseVarianHarga(str) {
    const obj = {};
    str.split(',').forEach(p => {
      const [key, val] = p.split('=');
      obj[key.trim().toUpperCase()] = Number(val || 0);
    });
    return obj;
  }

  function formatCurrency(num) {
    return "Rp" + Number(num).toLocaleString('id-ID');
  }
</script>

</body>
</html>
